// kepler.engine is part of Kepler, a 2D game engine for p5.js
// https://github.com/JustASideQuestNPC/kepler
!function(e){e.ENGINE_INCLUDED=!0,e.USES_RAW_DELTA_TIME=Symbol(),e.USES_SCREEN_SPACE_COORDS=Symbol(),e.Engine=class{get numEntities(){return this._entities.length}get deltaTimeRaw(){return this._lastDt}get deltaTime(){return this._lastDt*this.deltaTimeMultiplier}get tickRate(){return this._tickRate}set tickRate(e){this._tickRate=e,this._secondsPerTick=1/e}get renderTarget(){return this._renderTarget}set renderTarget(e){this._renderTarget=e,this._screenWidth=e.width,this._screenHeight=e.height,this.cameraAnchor=createVector(this._screenWidth/2,this._screenHeight/2),this.cameraPos=this.cameraAnchor,this.worldWidth=this._screenWidth,this.worldHeight=this._screenHeight}get renderWidth(){return this._screenWidth}get renderHeight(){return this._screenHeight}get cameraPos(){return this._cameraPos}set cameraPos(e){this._cameraPos=e,this.cameraTarget=e}get cameraAnchor(){return this._sketch.createVector(-this._cameraOffset.x,-this._cameraOffset.y)}set cameraAnchor(e){this._cameraOffset.x=-e.x,this._cameraOffset.y=-e.y}get worldWidth(){return this._worldWidth}set worldWidth(e){this._worldWidth=e,this._maxRenderX=this._worldWidth-this._screenWidth}get worldHeight(){return this._worldHeight}set worldHeight(e){this._worldHeight=e,this._maxRenderY=this._worldHeight-this._screenHeight}constructor({sketch:e,renderTarget:t=null,tickRate:r=null,cameraAnchor:s=null,cameraPos:i=null,useCameraBoundary:h=!1,worldWidth:a=null,worldHeight:n=null}={}){this._sketch=e,this._entities=[],this._lastDt=0,this._dtCounter=0,this.deltaTimeMultiplier=1,this._cameraPos=e.createVector(),this.cameraTarget=e.createVector(),this._cameraOffset=e.createVector(),this.cameraTightness=1,this.useCameraBoundary=!1,this._renderX=0,this._renderY=0,this.renderTarget=t||e,this.tickRate=r||e.getTargetFrameRate(),null!=s?this.cameraAnchor=this._sketch.createVector(s.x,s.y):this.cameraAnchor=this._sketch.createVector(this._screenWidth/2,this._screenHeight/2),null!=i?this.cameraPos=this._sketch.createVector(i.x,i.y):this.cameraPos=this.cameraAnchor.copy(),this.useCameraBoundary=h,this._worldWidth=a||this._worldWidth,this._worldHeight=n||this._worldHeight}addEntity(e){return e.engine=this,e.tags=e.tags||[],e.markForDelete=e.markForDelete||!1,e.setup(),this._entities.push(e),e}update(){if(this._dtCounter+=this._sketch.deltaTime/1e3,this._dtCounter<this._secondsPerTick)return;this._lastDt=this._dtCounter,this._dtCounter=0;let t=this._lastDt*this.deltaTimeMultiplier;for(let r of this._entities)r.markForDelete||(r.hasTag(e.USES_RAW_DELTA_TIME)?r.update(this.deltaTimeRaw):r.update(t));this._entities=this._entities.filter(e=>!e.markForDelete),this._cameraPos.equals(this.cameraTarget)||this._cameraPos.lerp(this.cameraTarget,this.cameraTightness)}render(){for(let t of(this._renderX=this._cameraPos.x+this._cameraOffset.x,this._renderY=this._cameraPos.y+this._cameraOffset.y,this.useCameraBoundary&&(this._renderX=this._sketch.constrain(this._renderX,0,this._maxRenderX),this._renderY=this._sketch.constrain(this._renderY,0,this._maxRenderY)),this._renderTarget.push(),this._renderTarget.translate(-this._renderX,-this._renderY),this._entities))t.hasTag(e.USES_SCREEN_SPACE_COORDS)?(this._renderTarget.translate(this._renderX,this._renderY),t.render(this._renderTarget),this._renderTarget.translate(-this._renderX,-this._renderY)):t.render(this._renderTarget);this._renderTarget.pop()}removeIf(e){this._entities=this._entities.filter(t=>e(t))}removeTagged(e){this.removeIf(t=>t.hasTag(e))}removeAll(){this._entities=[]}getIf(e){return this._entities.filter(t=>e(t))}getTagged(e){return this.getIf(t=>t.hasTag(e))}screenPosToWorldPos(e,t){return e.constructor===p5.Vector?this._sketch.createVector(e.x+this._renderX,e.y+this._renderY):[e+this._renderX,t+this._renderY]}worldPosToScreenPos(e,t){return e.constructor===p5.Vector?this._sketch.createVector(e.x-this._renderX,e.y-this._renderY):[e-this._renderX,t-this._renderY]}},e.Entity=class{update(e){}render(e){}setup(){}hasTag(e){return this.tags.includes(e)}constructor(){if(new.target===e.Entity)throw Error("Kepler.Entity is an abstract class and cannot be instantiated directly (extend it instead)!")}}}(window.Kepler=window.Kepler||{});