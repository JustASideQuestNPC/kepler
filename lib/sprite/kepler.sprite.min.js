// kepler.sprite is part of Kepler, a 2D game engine for p5.js
// https://github.com/JustASideQuestNPC/kepler
!function(t){t.SPRITE_INCLUDED=!0;let e=Symbol();t.SpriteLoader=class{#a={};#b;constructor(t){this.#b=t}makeImageSprite(s){return new t.ImageSprite(e,this.#a[s])}makeAnimatedSprite(s){return new t.AnimatedSprite(e,this.#a[s])}async loadSprite(t){let e,s,a;if("string"==typeof t){a={path:t};let i=t;e=i.split("/").pop(),a.folderPath=i.join("/")+"/",e=e.replace(/\.[^/.]+$/,""),s=entry.slice((t.lastIndexOf(".")-1>>>0)+2)}else{a=t,e=t.hasOwnProperty("name")?t.name:(e=t.path.split("/").pop()).replace(/\.[^/.]+$/,"");let h=t.path.split("/");h.pop(),a.folderPath=h.join("/")+"/",s=t.path.slice((t.path.lastIndexOf(".")-1>>>0)+2)}"png"===s||"jpg"===s?await this.#c(e,a):"json"===s&&await this.#d(e,a)}async loadSpriteList(t){await this.#b.loadJSON(t,t=>{for(let[e,s]of Object.entries(t))s.name=e,this.loadSprite(s)})}async #c(s,{path:a,position:i={x:0,y:0},anchor:h={x:"center",y:"center"},rotation:r=0,scale:n={x:1,y:1},size:c={width:null,height:null}}){await this.#b.loadImage(a,t=>{let e={animated:!1,sketch:this.#b};e.image=t,e.anchor=[],"number"==typeof h.x?e.anchor[0]=h.x:"left"===h.x?e.anchor[0]=0:"right"===h.x?e.anchor[0]=e.image.width:"center"===h.x&&(e.anchor[0]=e.image.width/2),"number"==typeof h.y?e.anchor[1]=h.y:"top"===h.y?e.anchor[1]=0:"bottom"===h.y?e.anchor[1]=e.image.height:"center"===h.y&&(e.anchor[1]=e.image.height/2),e.scale=[n.x,n.y],null!=c.width&&(e.scale[0]=c.width/e.image.width),null!=c.height&&(e.scale[1]=c.height/e.image.height),e.position=[i.x,i.y],e.rotation=r,this.#a[s]=e})}async #d(o,l){await this.#b.loadJSON(l.path,async t=>{await this.#b.loadImage(l.folderPath+t.meta.image,async e=>{await this.#e(o,t,e,l)})})}async #e(p,d,m,{position:y={x:0,y:0},anchor:g={x:"center",y:"center"},frameRate:x=20,playbackMode:u="loop",playbackSpeed:f=1,paused:I=!1,startTag:$=null,rotation:k=0,scale:S={x:1,y:1},size:w={width:null,height:null}}){let _={animated:!0,sketch:this.#b,position:[y.x,y.y],frameRate:x,playbackSpeed:f,paused:I,rotation:k,scale:[S.x,S.y]};_.playbackMode=u;let b=d.frames,A=d.meta,T=b[Object.keys(b)[0]].sourceSize.w,D=b[Object.keys(b)[0]].sourceSize.h;for(let F of(null!=w.width&&(_.scale[0]=w.width/T),null!=w.height&&(_.scale[1]=w.height/D),_.anchor=[],"number"==typeof g.x?_.anchor[0]=g.x:"left"===g.x?_.anchor[0]=0:"right"===g.x?_.anchor[0]=T:"center"===g.x&&(_.anchor[0]=T/2),"number"==typeof g.y?_.anchor[1]=g.y:"top"===g.y?_.anchor[1]=0:"bottom"===g.y?_.anchor[1]=D:"center"===g.y&&(_.anchor[1]=D/2),_.frames=[],Object.keys(b))){let z=b[F];if(z.trimmed){let M=this.#b.createImage(T,D);M.copy(m,z.frame.x,z.frame.y,z.frame.w,z.frame.h,z.spriteSourceSize.x,z.spriteSourceSize.y,z.spriteSourceSize.w,z.spriteSourceSize.h),_.frames.push(M)}else _.frames.push(m.get(z.frame.x,z.frame.y,z.frame.w,z.frame.h))}if(A.hasOwnProperty("frameTags")&&0!==A.frameTags.length){for(let O of(_.tags={},A.frameTags))_.tags[O.name]={start:O.from,end:O.to};_.startTag=$||Object.keys(_.tags)[0]}else _.tags={main:{start:0,end:_.frames.length-1}},_.startTag="main";this.#a[p]=_}},t.ImageSprite=class{#f;#b;position;displayAnchor;rotation;#g;get x(){return this.position.x}set x(t){this.position.x=t}get y(){return this.position.y}set y(t){this.position.y=t}get anchorX(){return this.displayAnchor.x}set anchorX(t){this.displayAnchor.x=t}get anchorY(){return this.displayAnchor.y}set anchorY(t){this.displayAnchor.y=t}get sourceWidth(){return this.#f.width}get sourceHeight(){return this.#f.height}get width(){return this.#f.width*this.#g.x}set width(t){this.#g.x=t/this.#f.width}get height(){return this.#f.height*this.#g.y}set height(t){this.#g.y=t/this.#f.height}constructor(t,e){this.#b=e.sketch,this.#f=e.image,this.position=this.#b.createVector(e.position[0],e.position[1]),this.displayAnchor=this.#b.createVector(e.anchor[0],e.anchor[1]),this.rotation=e.rotation,this.#g=this.#b.createVector(e.scale[0],e.scale[1])}render(t=this.#b){t.push(),t.translate(this.position.x,this.position.y),t.scale(this.#g.x,this.#g.y),t.rotate(this.rotation),t.image(this.#f,-this.displayAnchor.x,-this.displayAnchor.y),t.pop()}scale(t,e){null==e?(this.#g.x*=t,this.#g.y*=t):(this.#g.x*=t,this.#g.y*=e)}scaleAbsolute(t,e){null==e?(this.#g.x=t,this.#g.y=t):(this.#g.x=t,this.#g.y=e)}},t.AnimatedSprite=class{#h;#b;#i;#g;#j;#k;#l;#m;#n;#o;playbackMode;playbackSpeed;paused;position;displayAnchor;rotation;get x(){return this.position.x}set x(t){this.position.x=t}get y(){return this.position.y}set y(t){this.position.y=t}get anchorX(){return this.displayAnchor.x}set anchorX(t){this.displayAnchor.x=t}get anchorY(){return this.displayAnchor.y}set anchorY(t){this.displayAnchor.y=t}get sourceWidth(){return this.#h[0].width}get sourceHeight(){return this.#h[0].height}get width(){return this.#h[0].width*this.#g.x}set width(t){this.#g.x=t/this.#h[0].width}get height(){return this.#h[0].height*this.#g.y}set height(t){this.#g.y=t/this.#h[0].height}get frameRate(){return 1/this.#n}set frameRate(t){this.#n=1/t}get numFrames(){return this.#m-this.#l}get tagNames(){return Object.keys(this.#j)}get currentFrame(){return this.#i-this.#l}get currentTag(){return this.#k}constructor(t,e){this.#b=e.sketch,this.#h=e.frames,this.frameRate=e.frameRate,this.#o=this.#n,this.playbackMode=e.playbackMode,this.playbackSpeed=e.playbackSpeed,this.paused=e.paused,this.#j=e.tags,this.changeTag(e.startTag),this.position=this.#b.createVector(e.position[0],e.position[1]),this.displayAnchor=this.#b.createVector(e.anchor[0],e.anchor[1]),this.#g=this.#b.createVector(1,1),this.rotation=0}advanceFrame(t){this.#i+=t,"loop"===this.playbackMode?this.#i=((this.#i-this.#l)%this.numFrames+this.numFrames)%this.numFrames+this.#l:"ping pong"===this.playbackMode?this.#i<this.#l?(this.#i=this.#l,this.playbackSpeed*=-1):this.#i>this.#m&&(this.#i=this.#m,this.playbackSpeed*=-1):this.#i<this.#l?(this.#i=this.#l,this.paused=!0):this.#i>this.#m&&(this.#i=this.#m,this.paused=!0)}restart(t=!1){this.paused=t,this.playbackSpeed<0?this.#i=this.#m:this.#i=this.#l}changeTag(t){this.#k=t,this.#l=this.#j[this.#k].start,this.#m=this.#j[this.#k].end,this.playbackSpeed<0?this.#i=this.#m:this.#i=this.#l}update(t){!this.paused&&(this.#o-=t,this.#o<=0&&(this.advanceFrame(this.playbackSpeed/Math.abs(this.playbackSpeed)),this.#o=this.#n/Math.abs(this.playbackSpeed)))}render(t=this.#b){t.push(),t.translate(this.position.x,this.position.y),t.scale(this.#g.x,this.#g.y),t.rotate(this.rotation),t.image(this.#h[this.#i],-this.displayAnchor.x,-this.displayAnchor.y),t.pop()}scale(t,e){null==e?(this.#g.x*=t,this.#g.y*=t):(this.#g.x*=t,this.#g.y*=e)}scaleAbsolute(t,e){null==e?(this.#g.x=t,this.#g.y=t):(this.#g.x=t,this.#g.y=e)}}}(window.Kepler=window.Kepler||{});