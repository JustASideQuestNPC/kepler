// kepler.sprite is part of Kepler, a 2D game engine for p5.js
// https://github.com/JustASideQuestNPC/kepler
!function(t){t.SPRITE_INCLUDED=!0;let e=Symbol();t.SpriteLoader=class{constructor(t){this._sketch=t,this._spriteData={}}makeImageSprite(s){return new t.ImageSprite(e,this._spriteData[s])}makeAnimatedSprite(s){return new t.AnimatedSprite(e,this._spriteData[s])}loadSprite(t){let e,s,i;if("string"==typeof t){i={path:t};let a=t;e=a.split("/").pop(),i.folderPath=a.substring(0,a.lastIndexOf("/"))+"/",e=e.replace(/\.[^/.]+$/,""),s=t.slice((t.lastIndexOf(".")-1>>>0)+2)}else{i=t,e=t.hasOwnProperty("name")?t.name:(e=t.path.split("/").pop()).replace(/\.[^/.]+$/,"");let h=t.path.split("/");h.pop(),i.folderPath=h.join("/")+"/",s=t.path.slice(-4)}".png"===s||".jpg"===s?this._loadImageSprite(e,i):"json"===s&&this._loadAnimatedSprite(e,i)}loadSpriteList(t){this._sketch.loadJSON(t,t=>{for(let[e,s]of Object.entries(t))s.name=e,this.loadSprite(s)})}_loadImageSprite(t,{path:e,position:s={x:0,y:0},anchor:i={x:"center",y:"center"},rotation:a=0,scale:h={x:1,y:1},size:r={width:null,height:null}}){this._sketch.loadImage(e,e=>{let n={animated:!1,sketch:this._sketch};n.image=e,n.anchor=[],"number"==typeof i.x?n.anchor[0]=i.x:"left"===i.x?n.anchor[0]=0:"right"===i.x?n.anchor[0]=n.image.width:"center"===i.x&&(n.anchor[0]=n.image.width/2),"number"==typeof i.y?n.anchor[1]=i.y:"top"===i.y?n.anchor[1]=0:"bottom"===i.y?n.anchor[1]=n.image.height:"center"===i.y&&(n.anchor[1]=n.image.height/2),n.scale=[h.x,h.y],null!=r.width&&(n.scale[0]=r.width/n.image.width),null!=r.height&&(n.scale[1]=r.height/n.image.height),n.position=[s.x,s.y],n.rotation=a,this._spriteData[t]=n})}_loadAnimatedSprite(t,e){this._sketch.loadJSON(e.path,s=>{this._sketch.loadImage(e.folderPath+s.meta.image,i=>{this._parseSpriteSheet(t,s,i,e)})})}_parseSpriteSheet(t,e,s,{position:i={x:0,y:0},anchor:a={x:"center",y:"center"},frameRate:h=20,playbackMode:r="loop",playbackSpeed:n=1,paused:c=!1,startTag:o=null,rotation:l=0,scale:d={x:1,y:1},size:p={width:null,height:null}}){let m={animated:!0,sketch:this._sketch,position:[i.x,i.y],frameRate:h,playbackSpeed:n,paused:c,rotation:l,scale:[d.x,d.y]};m.playbackMode=r;let g=e.frames,y=e.meta,x=g[Object.keys(g)[0]].sourceSize.w,u=g[Object.keys(g)[0]].sourceSize.h;for(let f of(null!=p.width&&(m.scale[0]=p.width/x),null!=p.height&&(m.scale[1]=p.height/u),m.anchor=[],"number"==typeof a.x?m.anchor[0]=a.x:"left"===a.x?m.anchor[0]=0:"right"===a.x?m.anchor[0]=x:"center"===a.x&&(m.anchor[0]=x/2),"number"==typeof a.y?m.anchor[1]=a.y:"top"===a.y?m.anchor[1]=0:"bottom"===a.y?m.anchor[1]=u:"center"===a.y&&(m.anchor[1]=u/2),m.frames=[],Object.keys(g))){let I=g[f];if(I.trimmed){let S=this._sketch.createImage(x,u);S.copy(s,I.frame.x,I.frame.y,I.frame.w,I.frame.h,I.spriteSourceSize.x,I.spriteSourceSize.y,I.spriteSourceSize.w,I.spriteSourceSize.h),m.frames.push(S)}else m.frames.push(s.get(I.frame.x,I.frame.y,I.frame.w,I.frame.h))}if(y.hasOwnProperty("frameTags")&&0!==y.frameTags.length){for(let $ of(m.tags={},y.frameTags))m.tags[$.name]={start:$.from,end:$.to};m.startTag=o||Object.keys(m.tags)[0]}else m.tags={main:{start:0,end:m.frames.length-1}},m.startTag="main";this._spriteData[t]=m}},t.ImageSprite=class{get x(){return this.position.x}set x(t){this.position.x=t}get y(){return this.position.y}set y(t){this.position.y=t}get anchorX(){return this.displayAnchor.x}set anchorX(t){this.displayAnchor.x=t}get anchorY(){return this.displayAnchor.y}set anchorY(t){this.displayAnchor.y=t}get sourceWidth(){return this._image.width}get sourceHeight(){return this._image.height}get width(){return this._image.width*this._scale.x}set width(t){this._scale.x=t/this._image.width}get height(){return this._image.height*this._scale.y}set height(t){this._scale.y=t/this._image.height}constructor(t,s){if(t!==e)throw Error("ImageSprites cannot be instantiated directly - use SpriteLoader.makeImageSprite() instead!");this._sketch=s.sketch,this._image=s.image,this.position=this._sketch.createVector(s.position[0],s.position[1]),this.displayAnchor=this._sketch.createVector(s.anchor[0],s.anchor[1]),this.rotation=s.rotation,this._scale=this._sketch.createVector(s.scale[0],s.scale[1])}render(t=this._sketch){t.push(),t.translate(this.position.x,this.position.y),t.scale(this._scale.x,this._scale.y),t.rotate(this.rotation),t.image(this._image,-this.displayAnchor.x,-this.displayAnchor.y),t.pop()}scale(t,e){null==e?(this._scale.x*=t,this._scale.y*=t):(this._scale.x*=t,this._scale.y*=e)}scaleAbsolute(t,e){null==e?(this._scale.x=t,this._scale.y=t):(this._scale.x=t,this._scale.y=e)}},t.AnimatedSprite=class{get x(){return this.position.x}set x(t){this.position.x=t}get y(){return this.position.y}set y(t){this.position.y=t}get anchorX(){return this.displayAnchor.x}set anchorX(t){this.displayAnchor.x=t}get anchorY(){return this.displayAnchor.y}set anchorY(t){this.displayAnchor.y=t}get sourceWidth(){return this._frames[0].width}get sourceHeight(){return this._frames[0].height}get width(){return this._frames[0].width*this._scale.x}set width(t){this._scale.x=t/this._frames[0].width}get height(){return this._frames[0].height*this._scale.y}set height(t){this._scale.y=t/this._frames[0].height}get frameRate(){return 1/this._frameDelay}set frameRate(t){this._frameDelay=1/t}get numFrames(){return this._endIndex-this._startIndex}get tagNames(){return Object.keys(this._tags)}get currentFrame(){return this._frameIndex-this._startIndex}get currentTag(){return this._currentTag}constructor(t,s){if(t!==e)throw Error("AnimatedSprites cannot be instantiated directly - use SpriteLoader.makeAnimatedSprite() instead!");this._sketch=s.sketch,this._frames=s.frames,this.frameRate=s.frameRate,this._frameTimer=this._frameDelay,this.playbackMode=s.playbackMode,this.playbackSpeed=s.playbackSpeed,this.paused=s.paused,this._tags=s.tags,this.changeTag(s.startTag),this.position=this._sketch.createVector(s.position[0],s.position[1]),this.displayAnchor=this._sketch.createVector(s.anchor[0],s.anchor[1]),this._scale=this._sketch.createVector(1,1),this.rotation=0}advanceFrame(t){this._frameIndex+=t,"loop"===this.playbackMode?this._frameIndex=((this._frameIndex-this._startIndex)%this.numFrames+this.numFrames)%this.numFrames+this._startIndex:"ping pong"===this.playbackMode?this._frameIndex<this._startIndex?(this._frameIndex=this._startIndex,this.playbackSpeed*=-1):this._frameIndex>this._endIndex&&(this._frameIndex=this._endIndex,this.playbackSpeed*=-1):this._frameIndex<this._startIndex?(this._frameIndex=this._startIndex,this.paused=!0):this._frameIndex>this._endIndex&&(this._frameIndex=this._endIndex,this.paused=!0)}restart(t=!1){this.paused=t,this.playbackSpeed<0?this._frameIndex=this._endIndex:this._frameIndex=this._startIndex}changeTag(t){this._currentTag=t,this._startIndex=this._tags[this._currentTag].start,this._endIndex=this._tags[this._currentTag].end,this.playbackSpeed<0?this._frameIndex=this._endIndex:this._frameIndex=this._startIndex}update(t){!this.paused&&(this._frameTimer-=t,this._frameTimer<=0&&(this.advanceFrame(this.playbackSpeed/Math.abs(this.playbackSpeed)),this._frameTimer=this._frameDelay/Math.abs(this.playbackSpeed)))}render(t=this._sketch){t.push(),t.translate(this.position.x,this.position.y),t.scale(this._scale.x,this._scale.y),t.rotate(this.rotation),t.image(this._frames[this._frameIndex],-this.displayAnchor.x,-this.displayAnchor.y),t.pop()}scale(t,e){null==e?(this._scale.x*=t,this._scale.y*=t):(this._scale.x*=t,this._scale.y*=e)}scaleAbsolute(t,e){null==e?(this._scale.x=t,this._scale.y=t):(this._scale.x=t,this._scale.y=e)}}}(window.Kepler=window.Kepler||{});